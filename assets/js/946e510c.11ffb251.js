"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[30288],{73693:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var o=t(24246),r=t(71670);t(33337),t(39798);const a={slug:"moon-v1.30",title:"moon v1.30 - Python support, self-hosted remote caching, task graph, and more!",authors:["milesj"],tags:["affected","detection","tracker","task","graph","self-hosted","remote","cache","python","toolchain"],image:"./img/moon/v1.30.png"},s=void 0,i={permalink:"/blog/moon-v1.30",editUrl:"https://github.com/moonrepo/moon/tree/master/website/blog/2024-11-25_moon-v1.30.mdx",source:"@site/blog/2024-11-25_moon-v1.30.mdx",title:"moon v1.30 - Python support, self-hosted remote caching, task graph, and more!",description:"It's been almost 2 months since our last release, and we're excited to announce some major features",date:"2024-11-25T00:00:00.000Z",tags:[{inline:!0,label:"affected",permalink:"/blog/tags/affected"},{inline:!0,label:"detection",permalink:"/blog/tags/detection"},{inline:!0,label:"tracker",permalink:"/blog/tags/tracker"},{inline:!0,label:"task",permalink:"/blog/tags/task"},{inline:!0,label:"graph",permalink:"/blog/tags/graph"},{inline:!0,label:"self-hosted",permalink:"/blog/tags/self-hosted"},{inline:!0,label:"remote",permalink:"/blog/tags/remote"},{inline:!0,label:"cache",permalink:"/blog/tags/cache"},{inline:!0,label:"python",permalink:"/blog/tags/python"},{inline:!0,label:"toolchain",permalink:"/blog/tags/toolchain"}],readingTime:5.17,hasTruncateMarker:!0,authors:[{name:"Miles Johnson",title:"Founder, developer",url:"https://github.com/milesj",imageURL:"/img/authors/miles.jpg",key:"milesj"}],frontMatter:{slug:"moon-v1.30",title:"moon v1.30 - Python support, self-hosted remote caching, task graph, and more!",authors:["milesj"],tags:["affected","detection","tracker","task","graph","self-hosted","remote","cache","python","toolchain"],image:"./img/moon/v1.30.png"},unlisted:!1,prevItem:{title:"proto v0.44 - New terminal user interface and versions command",permalink:"/blog/proto-v0.44"},nextItem:{title:"proto v0.42 - New bin linking, JSON/YAML plugins, and more",permalink:"/blog/proto-v0.42"}},l={image:t(61891).Z,authorsImageUrls:[void 0]},c=[{value:"Experimental Python tier 2 and 3 support",id:"experimental-python-tier-2-and-3-support",level:2},{value:"New <code>python</code> configurations",id:"new-python-configurations",level:3},{value:"Built-in virtual environments",id:"built-in-virtual-environments",level:3},{value:"Unstable self-hosted remote caching",id:"unstable-self-hosted-remote-caching",level:2},{value:"Unsupported features",id:"unsupported-features",level:3},{value:"New task graph and improved affected tracker",id:"new-task-graph-and-improved-affected-tracker",level:2},{value:"Other changes",id:"other-changes",level:2}];function h(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"It's been almost 2 months since our last release, and we're excited to announce some major features\nrequested by the community!"}),"\n",(0,o.jsx)(n.h2,{id:"experimental-python-tier-2-and-3-support",children:"Experimental Python tier 2 and 3 support"}),"\n",(0,o.jsxs)(n.p,{children:["Thanks to a contribution from ",(0,o.jsx)(n.a,{href:"https://github.com/harlequin",children:"@harlequin"}),", we now provide Python tier\n",(0,o.jsx)(n.a,{href:"/docs/how-it-works/languages#tier-2--platform",children:"2"})," and\n",(0,o.jsx)(n.a,{href:"/docs/how-it-works/languages#tier-3--toolchain",children:"3"})," support. Python is a very popular language, so\nit was about time that we officially supported it in some capacity. When enabling Python in moon,\nthe following functionality will be enabled:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Will download and install Python into the toolchain (if ",(0,o.jsx)(n.code,{children:"python.version"})," is defined)."]}),"\n",(0,o.jsxs)(n.li,{children:["Will parse ",(0,o.jsx)(n.code,{children:"requirements.txt"})," to extract dependency and version information for hashing."]}),"\n",(0,o.jsxs)(n.li,{children:["Will automatically activate virtual environments and setup ",(0,o.jsx)(n.code,{children:"PATH"})," for tasks."]}),"\n",(0,o.jsxs)(n.li,{children:["Will automatically install dependencies for ",(0,o.jsx)(n.code,{children:"requirements.txt"})," via pip."]}),"\n",(0,o.jsx)(n.li,{children:"And a handful of internal interoperability features."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"However, we're still marking this implementation as experimental, as it hasn't been thoroughly\ntested, and we're not 100% positive the workflows are what users expect. So please provide any\nfeedback, good or bad!"}),"\n",(0,o.jsxs)(n.p,{children:["Furthermore, as mentioned above, we install dependencies with pip (the version of pip that comes\npre-installed with the current Python version). At this time, ",(0,o.jsx)(n.em,{children:"we do not support"})," other package\nmanagers like Poetry, Hatch, PDM, Rye, or uv, but we will in the future!"]}),"\n",(0,o.jsxs)(n.h3,{id:"new-python-configurations",children:["New ",(0,o.jsx)(n.code,{children:"python"})," configurations"]}),"\n",(0,o.jsxs)(n.p,{children:["Languages in\n",(0,o.jsx)(n.a,{href:"/docs/how-it-works/languages#enabling-a-language",children:"moon are enabled through configuration"})," blocks in\n",(0,o.jsx)(n.a,{href:"/docs/config/toolchain",children:(0,o.jsx)(n.code,{children:".moon/toolchain.yml"})}),", and Python is no different. We now support a\n",(0,o.jsx)(n.a,{href:"/docs/config/toolchain#python",children:(0,o.jsx)(n.code,{children:"python"})})," toolchain setting\n(",(0,o.jsx)(n.a,{href:"/docs/config/toolchain",children:"view all available settings"}),")."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",metastring:'title=".moon/toolchain.yml"',children:"python:\n  version: '3.14.0'\n"})}),"\n",(0,o.jsxs)(n.p,{children:["When the ",(0,o.jsx)(n.code,{children:"python"})," setting is defined, it will enable the language and\n",(0,o.jsx)(n.a,{href:"/docs/how-it-works/languages#tier-2--platform",children:"deep platform integration"}),", and when the\n",(0,o.jsx)(n.code,{children:"python.version"})," field is defined, it will further enable\n",(0,o.jsx)(n.a,{href:"/docs/how-it-works/languages#tier-3--toolchain",children:"toolchain support"}),". Both of these features provide\nheavy automation, improving the overall developer experience."]}),"\n",(0,o.jsxs)(n.p,{children:["This is fantastic, but what if another Python project in the monorepo requires a different toolchain\nchannel/version? If so, they can use the new ",(0,o.jsx)(n.a,{href:"/docs/config/project#python",children:(0,o.jsx)(n.code,{children:"toolchain.python"})}),"\nsetting in ",(0,o.jsx)(n.a,{href:"/docs/config/project",children:(0,o.jsx)(n.code,{children:"moon.yml"})})," to define project-level overrides."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",metastring:'title="<project>/moon.yml"',children:"toolchain:\n  python:\n    version: '3.12.0'\n"})}),"\n",(0,o.jsx)(n.h3,{id:"built-in-virtual-environments",children:"Built-in virtual environments"}),"\n",(0,o.jsxs)(n.p,{children:["Of course we also have support for Python virtual environments. When running a task, moon will\nautomatically enable the virtual environment in the workspace root or a project root (depending on\nconfig)! The name of the venv can be customized with the\n",(0,o.jsx)(n.a,{href:"/docs/config/toolchain#venvname",children:(0,o.jsx)(n.code,{children:"python.venvName"})})," setting, otherwise it defaults to ",(0,o.jsx)(n.code,{children:".venv"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",metastring:'title=".moon/toolchain.yml"',children:"python:\n  venvName: '.venvcustom'\n"})}),"\n",(0,o.jsx)(n.h2,{id:"unstable-self-hosted-remote-caching",children:"Unstable self-hosted remote caching"}),"\n",(0,o.jsxs)(n.p,{children:["This has been a request from the community for a very long time, and we get it, not every user wants\nto store their build artifacts (not source code) in a third-party cloud provider. While we're proud\nof our ",(0,o.jsx)(n.a,{href:"/moonbase",children:"moonbase service"}),", it wasn't a viable option for many companies because of their\nproprietary requirements. We spent a few months reworking moonbase to work as a self-hosted service,\nso users can host it as on-prem solution, but it has been a very costly initiative. During this\nprocess, we came to the conclusion that spending our time and resources on moonbase simply isn't\nworth it, so we made the hard decision to sunset moonbase in the future."]}),"\n",(0,o.jsxs)(n.p,{children:["So what does that mean for remote caching? Simply put, you can now host your own remote caching\nservice! Instead of building a custom API for consumers to implement, we opted to implement the\n",(0,o.jsx)(n.a,{href:"https://github.com/bazelbuild/remote-apis/blob/main/build/bazel/remote/execution/v2/remote_execution.proto",children:"Bazel Remote Execution API"}),",\nwhich supports a content addressable storage (CAS) API, and is used by other popular build tools,\nlike Bazel, Buck, Pants, and more!"]}),"\n",(0,o.jsxs)(n.p,{children:["Because we opted for a community solution, we can now focus all our efforts on ",(0,o.jsx)(n.a,{href:"/moon",children:"moon"})," and\n",(0,o.jsx)(n.a,{href:"/proto",children:"proto"}),"! Additionally, adopting RE API allows you, the user, to use an off-the-shelf\nsolution, like ",(0,o.jsx)(n.a,{href:"https://github.com/buchgr/bazel-remote",children:(0,o.jsx)(n.code,{children:"bazel-remote"})}),", instead of building your\nown custom caching server! For example, to make use of remote caching, simply serve ",(0,o.jsx)(n.code,{children:"bazel-remote"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"bazel-remote --dir /path/to/moon-cache --max_size 10 --storage_mode uncompressed --grpc_address 0.0.0.0:9092\n"})}),"\n",(0,o.jsxs)(n.p,{children:["And then configure the new ",(0,o.jsx)(n.a,{href:"/docs/config/workspace#unstable_remote",children:(0,o.jsx)(n.code,{children:"unstable_remote"})})," setting in\n",(0,o.jsx)(n.a,{href:"/docs/config/workspace",children:(0,o.jsx)(n.code,{children:".moon/workspace.yml"})}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",metastring:'title=".moon/workspace.yml"',children:"unstable_remote:\n  host: 'grpc://your-host.com:9092'\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Pretty awesome right? Jump to the\n",(0,o.jsx)(n.a,{href:"/docs/guides/remote-cache#self-hosted-unstable",children:"official remote caching"})," documentation for more\ninformation on this implementation."]}),"\n",(0,o.jsx)(n.h3,{id:"unsupported-features",children:"Unsupported features"}),"\n",(0,o.jsxs)(n.p,{children:["Since this is a new feature, we're marking it as unstable, as it hasn't been thoroughly tested, and\n",(0,o.jsx)(n.em,{children:"does not"})," support the entire Bazel RE API. The following features ",(0,o.jsx)(n.em,{children:"have not"})," been implemented, but\nwill be in the future."]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"HTTP(S) host (we only support gRPC(S))"}),"\n",(0,o.jsx)(n.li,{children:"Digest hashing functions besides SHA256"}),"\n",(0,o.jsx)(n.li,{children:"Compression formats (we only support identity/uncompressed right now)"}),"\n",(0,o.jsx)(n.li,{children:"Write/read bytestream for large blobs (4mb is the current limit)"}),"\n",(0,o.jsx)(n.li,{children:"Better TLS/mTLS support (it has some issues)"}),"\n",(0,o.jsx)(n.li,{children:"Directory blob types"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"new-task-graph-and-improved-affected-tracker",children:"New task graph and improved affected tracker"}),"\n",(0,o.jsxs)(n.p,{children:["In our ",(0,o.jsx)(n.a,{href:"./moon-v1.29#new-affected-projects-tracker",children:"last release"}),", we announced a new affected\ntracker for projects, but ",(0,o.jsx)(n.em,{children:"not"})," for tasks. The reason behind this was simple, we couldn't! Up until\nnow, we had no concept of a task graph, we had a project graph (that had tasks) and an action graph\n(that ran tasks), but the relationships between tasks were split across both of these graphs."]}),"\n",(0,o.jsxs)(n.p,{children:["This made it complicated to support tasks for the new affected tracker, as the action graph\n",(0,o.jsx)(n.em,{children:"consumes"})," the tracker, not the other way around. To remedy this issue, we now support an official\ntask graph, which is derived from the project graph, and then feeds into the action graph. Since the\ntask graph sits outside of the action graph, we're now able to support tasks in the affected\ntracker!"]}),"\n",(0,o.jsx)(n.p,{children:"Because of the new task graph, the following improvements have been introduced:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Tasks are now supported in the affected tracker (as mentioned)."}),"\n",(0,o.jsx)(n.li,{children:"We can now properly query dependencies and dependents of specific tasks."}),"\n",(0,o.jsx)(n.li,{children:"We can now associate types to relationships (graph edges). For example, in the future we can add\noptional, cleanup, and other kinds of dependencies."}),"\n",(0,o.jsxs)(n.li,{children:["We've added a new command, ",(0,o.jsx)(n.a,{href:"/docs/commands/task-graph",children:(0,o.jsx)(n.code,{children:"moon task-graph"})}),", that can visualize\ntasks in isolation."]}),"\n",(0,o.jsxs)(n.li,{children:["We've updated the ",(0,o.jsx)(n.a,{href:"/docs/commands/query/tasks",children:(0,o.jsx)(n.code,{children:"moon query tasks"})})," to derive information from the\ntask graph."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"other-changes",children:"Other changes"}),"\n",(0,o.jsxs)(n.p,{children:["View the ",(0,o.jsx)(n.a,{href:"https://github.com/moonrepo/moon/releases/tag/v1.30.0",children:"official release"})," for a full list\nof changes."]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Added basic support for Git submodules, and will now extract touched files from all submodules."}),"\n",(0,o.jsxs)(n.li,{children:["Added 7 new token variables: ",(0,o.jsx)(n.code,{children:"$arch"}),", ",(0,o.jsx)(n.code,{children:"$os"}),", ",(0,o.jsx)(n.code,{children:"$osFamily"}),", ",(0,o.jsx)(n.code,{children:"$vcsBranch"}),", ",(0,o.jsx)(n.code,{children:"$vcsRepository"}),",\n",(0,o.jsx)(n.code,{children:"$vcsRevision"}),", ",(0,o.jsx)(n.code,{children:"$workingDir"})]}),"\n",(0,o.jsxs)(n.li,{children:["Added a ",(0,o.jsx)(n.code,{children:"rust.binstallVersion"})," setting to ",(0,o.jsx)(n.code,{children:".moon/toolchain.yml"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Updated Pkl configurations to support ",(0,o.jsx)(n.code,{children:"read()"})," for environment variables."]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},39798:(e,n,t)=>{t.d(n,{Z:()=>s});t(27378);var o=t(40624);const r={tabItem:"tabItem_wHwb"};var a=t(24246);function s(e){let{children:n,hidden:t,className:s}=e;return(0,a.jsx)("div",{role:"tabpanel",className:(0,o.Z)(r.tabItem,s),hidden:t,children:n})}},33337:(e,n,t)=>{t.d(n,{Z:()=>p});var o=t(27378),r=t(40624),a=t(83457),s=t(35595),i=t(76457);const l={tabList:"tabList_J5MA",tabItem:"tabItem_l0OV"};var c=t(24246);function h(e){let{className:n,block:t,selectedValue:o,selectValue:s,tabValues:i}=e;const h=[],{blockElementScrollPositionUntilNextRender:d}=(0,a.o5)(),u=e=>{const n=e.currentTarget,t=h.indexOf(n),r=i[t].value;r!==o&&(d(n),s(r))},p=e=>{let n=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const t=h.indexOf(e.currentTarget)+1;n=h[t]??h[0];break}case"ArrowLeft":{const t=h.indexOf(e.currentTarget)-1;n=h[t]??h[h.length-1];break}}n?.focus()};return(0,c.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":t},n),children:i.map((e=>{let{value:n,label:t,attributes:a}=e;return(0,c.jsx)("li",{role:"tab",tabIndex:o===n?0:-1,"aria-selected":o===n,ref:e=>h.push(e),onKeyDown:p,onClick:u,...a,className:(0,r.Z)("tabs__item",l.tabItem,a?.className,{"tabs__item--active":o===n}),children:t??n},n)}))})}function d(e){let{lazy:n,children:t,selectedValue:r}=e;const a=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=a.find((e=>e.props.value===r));return e?(0,o.cloneElement)(e,{className:"margin-top--md"}):null}return(0,c.jsx)("div",{className:"margin-top--md",children:a.map(((e,n)=>(0,o.cloneElement)(e,{key:n,hidden:e.props.value!==r})))})}function u(e){const n=(0,s.Y)(e);return(0,c.jsxs)("div",{className:(0,r.Z)("tabs-container",l.tabList),children:[(0,c.jsx)(h,{...n,...e}),(0,c.jsx)(d,{...n,...e})]})}function p(e){const n=(0,i.Z)();return(0,c.jsx)(u,{...e,children:(0,s.h)(e.children)},String(n))}},35595:(e,n,t)=>{t.d(n,{Y:()=>p,h:()=>c});var o=t(27378),r=t(3620),a=t(9834),s=t(30654),i=t(70784),l=t(55643);function c(e){return o.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,o.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:t}=e;return(0,o.useMemo)((()=>{const e=n??function(e){return c(e).map((e=>{let{props:{value:n,label:t,attributes:o,default:r}}=e;return{value:n,label:t,attributes:o,default:r}}))}(t);return function(e){const n=(0,i.l)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function d(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function u(e){let{queryString:n=!1,groupId:t}=e;const a=(0,r.k6)(),i=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,s._X)(i),(0,o.useCallback)((e=>{if(!i)return;const n=new URLSearchParams(a.location.search);n.set(i,e),a.replace({...a.location,search:n.toString()})}),[i,a])]}function p(e){const{defaultValue:n,queryString:t=!1,groupId:r}=e,s=h(e),[i,c]=(0,o.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!d({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const o=t.find((e=>e.default))??t[0];if(!o)throw new Error("Unexpected error: 0 tabValues");return o.value}({defaultValue:n,tabValues:s}))),[p,m]=u({queryString:t,groupId:r}),[f,g]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[r,a]=(0,l.Nk)(t);return[r,(0,o.useCallback)((e=>{t&&a.set(e)}),[t,a])]}({groupId:r}),b=(()=>{const e=p??f;return d({value:e,tabValues:s})?e:null})();(0,a.Z)((()=>{b&&c(b)}),[b]);return{selectedValue:i,selectValue:(0,o.useCallback)((e=>{if(!d({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);c(e),m(e),g(e)}),[m,g,s]),tabValues:s}}},61891:(e,n,t)=>{t.d(n,{Z:()=>o});const o=t.p+"assets/images/v1.30-3b0701d50ef43787dfb4cd7545d8a2bf.png"},71670:(e,n,t)=>{t.d(n,{Z:()=>i,a:()=>s});var o=t(27378);const r={},a=o.createContext(r);function s(e){const n=o.useContext(a);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),o.createElement(a.Provider,{value:n},e.children)}}}]);